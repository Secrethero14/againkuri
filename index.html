<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kurigramians Star ‚Äî Real-time Achievers Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase compat SDKs (loaded but not initialized until you paste config) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <style>
    .glass{backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18)}
    .shadow-soft{box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .gradient-title{background:linear-gradient(90deg,#fff 0%,#fde68a 40%,#86efac 80%);-webkit-background-clip:text;background-clip:text;color:transparent}
    .badge{background:linear-gradient(135deg,#22d3ee,#a78bfa)}
    .tag{background:linear-gradient(135deg,#34d399,#60a5fa)}
    .btn-primary{background:linear-gradient(135deg,#22c55e,#16a34a)}
    .btn-primary:hover{filter:brightness(.95)}
    .btn-secondary{background:linear-gradient(135deg,#38bdf8,#6366f1)}
    .btn-secondary:hover{filter:brightness(.95)}
    .btn-danger{background:linear-gradient(135deg,#fb7185,#ef4444)}
    .btn-danger:hover{filter:brightness(.95)}
    .focus-ring:focus{outline:none;box-shadow:0 0 0 4px rgba(99,102,241,.35)}
    .card-hover{transition:transform 200ms ease,box-shadow 200ms ease,background 200ms ease}
    .card-hover:hover{transform:translateY(-2px)}
    .accordion-content{max-height:0;overflow:hidden;transition:max-height 250ms ease}
    .accordion.open .accordion-content{max-height:1200px}
    .modal{position:fixed;inset:0;display:none;z-index:50}
    .modal.open{display:flex}
    /* ‡¶°‡ßç‡¶∞‡¶™‡¶°‡¶æ‡¶â‡¶® ‡¶Æ‡ßá‡¶®‡ßÅ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
    option {
      background-color: #333333; /* ‡¶ó‡¶æ‡ßù ‡¶ß‡ßÇ‡¶∏‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° */
      color: white; /* ‡¶∏‡¶æ‡¶¶‡¶æ ‡¶≤‡ßá‡¶ñ‡¶æ */
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-700 via-teal-700 to-indigo-800 text-white">
  <!-- Top notice -->
  <div id="modeBanner" class="w-full bg-amber-400/90 text-emerald-950 text-sm">
    <div class="max-w-6xl mx-auto px-4 py-2 flex flex-col md:flex-row gap-2 md:items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-emerald-900/20 text-emerald-900">‚ÑπÔ∏è</span>
        <p id="modeText">Local mode: data is saved in this browser only. Click ‚ÄúFirebase Setup‚Äù to enable real-time sync for everyone.</p>
      </div>
      <button id="openSetupBtn" class="px-3 py-1.5 rounded-lg btn-secondary text-white">Firebase Setup</button>
    </div>
  </div>

  <!-- Header / Hero -->
  <header class="max-w-6xl mx-auto px-4 pt-10 pb-6">
    <div class="glass rounded-2xl p-6 md:p-10 shadow-soft">
      <div class="flex flex-col lg:flex-row gap-8 items-start lg:items-center">
        <div class="flex-1">
          <h1 class="text-3xl md:text-5xl font-extrabold leading-tight gradient-title">Kurigramians Star</h1>
          <p class="mt-3 md:mt-4 text-emerald-50/90 text-base md:text-lg">
            Celebrating achievers from Kurigram‚Äôs 9 upazilas‚Äîso their stories inspire the next.
          </p>
          <div class="mt-4 flex flex-wrap gap-2">
            <span class="px-3 py-1 text-xs md:text-sm rounded-full badge">Kurigram Sadar</span>
            <span class="px-3 py-1 text-xs md:text-sm rounded-full badge">Rajarhat</span>
            <span class="px-3 py-1 text-xs md:text-sm rounded-full badge">Chilmari</span>
            <span class="px-3 py-1 text-xs md:text-sm rounded-full badge">Ulipur</span>
            <span class="px-3 py-1 text-xs md:text-sm rounded-full badge">Nageshwari</span>
            <span class="px-3 py-1 text-xs md:text-sm rounded-full badge">Char Rajibpur</span>
            <span class="px-3 py-1 text-xs md:text-sm rounded-full badge">Bhurungamari</span>
            <span class="px-3 py-1 text-xs md:text-sm rounded-full badge">Phulbari</span>
            <span class="px-3 py-1 text-xs md:text-sm rounded-full badge">Rowmari</span>
          </div>
        </div>
        <div class="w-full lg:w-auto flex gap-3">
          <button id="openFormBtn" class="inline-flex items-center gap-2 px-5 py-3 rounded-xl btn-primary shadow-soft">
            <span>+ Add Achievement</span>
          </button>
          <button id="openSetupBtn2" class="inline-flex items-center gap-2 px-5 py-3 rounded-xl glass">
            <span>‚öôÔ∏è Firebase Setup</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Tabs -->
  <section class="max-w-6xl mx-auto px-4">
    <div class="flex gap-2 md:gap-3 mb-6">
      <button id="tabDirectory" class="px-4 md:px-6 py-2 rounded-full btn-secondary focus-ring">Directory</button>
      <button id="tabUpazilas" class="px-4 md:px-6 py-2 rounded-full glass focus-ring">Upazila Sections</button>
      <a href="#how-it-works" class="px-4 md:px-6 py-2 rounded-full glass focus-ring">Guide</a>
    </div>
  </section>

  <main class="max-w-6xl mx-auto px-4 pb-16">
    <!-- Directory: search and list -->
    <section id="directoryView" class="glass rounded-2xl p-6 md:p-8 shadow-soft mb-8">
      <div class="flex flex-col md:flex-row md:items-end gap-4 md:gap-6">
        <div class="flex-1">
          <label class="block text-sm text-emerald-100/90 mb-1">Search</label>
          <div class="relative">
            <input id="searchInput" placeholder="Search by name, job type, organization, or location..."
                   class="w-full rounded-xl px-4 py-3 bg-white/10 text-white placeholder-white/60 focus-ring pr-10" />
            <span class="absolute right-3 top-2.5">üîç</span>
          </div>
        </div>
        <div class="w-full md:w-56">
          <label class="block text-sm text-emerald-100/90 mb-1">Filter by Upazila</label>
          <select id="filterUpazila" class="w-full rounded-xl px-4 py-3 bg-white/10 text-white focus-ring">
            <option value="">All Upazilas</option>
            <option>Kurigram Sadar</option><option>Rajarhat</option><option>Chilmari</option>
            <option>Ulipur</option><option>Nageshwari</option><option>Char Rajibpur</option>
            <option>Bhurungamari</option><option>Phulbari</option><option>Rowmari</option>
          </select>
        </div>
        <div class="w-full md:w-56">
          <label class="block text-sm text-emerald-100/90 mb-1">Filter by Job Type</label>
          <select id="filterJobType" class="w-full rounded-xl px-4 py-3 bg-white/10 text-white focus-ring">
            <option value="">All Job Types</option>
          </select>
        </div>
      </div>

      <div id="directoryList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mt-6">
        <!-- Cards injected here -->
      </div>

      <div id="emptyState" class="hidden mt-8 text-center text-emerald-50/80">
        No results found. Try clearing filters or add the first achievement using ‚Äú+ Add Achievement‚Äù.
      </div>
    </section>

    <!-- Upazila Sections -->
    <section id="upazilaView" class="hidden">
      <div class="space-y-4 md:space-y-6" id="upazilaSections"></div>
    </section>

    <!-- How it works -->
    <section id="how-it-works" class="glass rounded-2xl p-6 md:p-8 shadow-soft">
      <h3 class="text-xl md:text-2xl font-bold mb-4">How this works</h3>
      <ul class="list-disc pl-6 space-y-2 text-emerald-50/90">
        <li>Anyone can add their achievement using the button above.</li>
        <li>In Firebase mode, everyone sees updates instantly across devices.</li>
        <li>You can edit/delete only what you added from your device (or Firebase anonymous user).</li>
        <li>Use search and filters to quickly find achievers by upazila or job type.</li>
      </ul>
    </section>
  </main>

  <!-- Footer -->
  <footer class="border-t border-white/15">
    <div class="max-w-6xl mx-auto px-4 py-8 md:py-10 text-center">
      <p class="text-lg md:text-xl italic text-emerald-50/90">
        ‚ÄúWork hard, shine yourself, shine the name of Kurigramians... Proud to be a Kurigramian.‚Äù
      </p>
      <p class="mt-4 text-emerald-50/70 text-sm">¬© <span id="yearNow"></span> Kurigramians Star</p>
    </div>
  </footer>

  <!-- Add/Edit Modal -->
  <div id="formModal" class="modal items-center justify-center px-4">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative glass rounded-2xl shadow-soft max-w-2xl w-full p-6 md:p-8">
      <div class="flex items-center justify-between mb-4">
        <h2 id="formTitle" class="text-2xl md:text-3xl font-bold">Add Achievement</h2>
        <button id="closeFormBtn" class="px-3 py-2 rounded-lg glass">‚úñ</button>
      </div>
      <form id="achievementForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <input type="hidden" id="editId" value="" />
        <div>
          <label class="block text-sm text-emerald-100/90 mb-1">Full Name</label>
          <input id="name" required placeholder="e.g., Rahim Uddin"
                 class="w-full rounded-xl px-4 py-3 bg-white/10 text-white placeholder-white/60 focus-ring" />
        </div>
        <div>
          <label class="block text-sm text-emerald-100/90 mb-1">Upazila</label>
          <select id="upazila" required class="w-full rounded-xl px-4 py-3 bg-white/10 text-white focus-ring">
            <option value="" disabled selected>Select upazila</option>
            <option>Kurigram Sadar</option><option>Rajarhat</option><option>Chilmari</option>
            <option>Ulipur</option><option>Nageshwari</option><option>Char Rajibpur</option>
            <option>Bhurungamari</option><option>Phulbari</option><option>Rowmari</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-emerald-100/90 mb-1">Job Type</label>
          <input id="jobType" required placeholder="e.g., BCS Cadre, Teacher, Govt. Officer"
                 class="w-full rounded-xl px-4 py-3 bg-white/10 text-white placeholder-white/60 focus-ring" />
        </div>
        <div>
          <label class="block text-sm text-emerald-100/90 mb-1">Job Location</label>
          <input id="jobLocation" required placeholder="e.g., Dhaka, Kurigram"
                 class="w-full rounded-xl px-4 py-3 bg-white/10 text-white placeholder-white/60 focus-ring" />
        </div>
        <div>
          <label class="block text-sm text-emerald-100/90 mb-1">Year</label>
          <input id="year" required type="number" min="1950" max="2100" placeholder="e.g., 2024"
                 class="w-full rounded-xl px-4 py-3 bg-white/10 text-white placeholder-white/60 focus-ring" />
        </div>
        <div>
          <label class="block text-sm text-emerald-100/90 mb-1">Organization</label>
          <input id="organization" required placeholder="e.g., Ministry of Education"
                 class="w-full rounded-xl px-4 py-3 bg-white/10 text-white placeholder-white/60 focus-ring" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-emerald-100/90 mb-1">Contact (Phone/Email)</label>
          <input id="contact" placeholder="Optional ‚Äî e.g., 017... or name@email.com"
                 class="w-full rounded-xl px-4 py-3 bg-white/10 text-white placeholder-white/60 focus-ring" />
        </div>
        <div class="md:col-span-2 flex items-center gap-3 pt-2">
          <button id="saveBtn" type="submit" class="px-5 py-3 rounded-xl btn-primary font-semibold">Save Achievement</button>
          <button id="cancelEditBtn" type="button" class="px-5 py-3 rounded-xl glass hidden">Cancel Edit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase Setup Modal -->
  <div id="setupModal" class="modal items-center justify-center px-4">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative glass rounded-2xl shadow-soft max-w-3xl w-full p-6 md:p-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl md:text-3xl font-bold">Firebase Setup</h2>
        <button id="closeSetupBtn" class="px-3 py-2 rounded-lg glass">‚úñ</button>
      </div>
      <div class="space-y-4">
        <p class="text-emerald-50/90 text-sm md:text-base">
          Paste your Firebase web config JSON here. We‚Äôll store it safely in your browser and enable real-time sync.
        </p>
        <textarea id="firebaseConfigInput" rows="8" placeholder='Example:
{
  "apiKey": "YOUR_KEY",
  "authDomain": "your-project.firebaseapp.com",
  "projectId": "your-project",
  "appId": "APP_ID"
}'
          class="w-full rounded-xl px-4 py-3 bg-white/10 text-white placeholder-white/60 focus-ring"></textarea>
        <div class="flex flex-wrap gap-3">
          <button id="saveConfigBtn" class="px-5 py-3 rounded-xl btn-primary font-semibold">Save & Connect</button>
          <button id="clearConfigBtn" class="px-5 py-3 rounded-xl btn-danger">Clear Config</button>
          <a href="https://firebase.google.com/docs/web/setup" target="_blank" rel="noopener noreferrer"
             class="px-5 py-3 rounded-xl glass">Open Firebase Guide ‚Üó</a>
        </div>
        <div id="setupStatus" class="text-sm text-emerald-50/80"></div>
      </div>
    </div>
  </div>

  <script>
    // Constants
    const UPZs = ["Kurigram Sadar","Rajarhat","Chilmari","Ulipur","Nageshwari","Char Rajibpur","Bhurungamari","Phulbari","Rowmari"];
    const LS_KEYS = {
      deviceToken: "ks_device_token_v2",
      achievements: "ks_achievements_v2",
      fbConfig: "ks_firebase_config_v1"
    };

    // State
    const state = {
      mode: "local",       // "local" or "firebase"
      achievements: [],
      filters: { query: "", upazila: "", jobType: "" },
      editingId: null,
      firebase: {
        app: null,
        db: null,
        auth: null,
        uid: null,
        unsub: null
      }
    };

    // Elements
    const yearNow = document.getElementById("yearNow");
    const directoryView = document.getElementById("directoryView");
    const upazilaView = document.getElementById("upazilaView");
    const upazilaSections = document.getElementById("upazilaSections");
    const directoryList = document.getElementById("directoryList");
    const emptyState = document.getElementById("emptyState");
    const searchInput = document.getElementById("searchInput");
    const filterUpazila = document.getElementById("filterUpazila");
    const filterJobType = document.getElementById("filterJobType");
    const tabDirectory = document.getElementById("tabDirectory");
    const tabUpazilas = document.getElementById("tabUpazilas");

    const formModal = document.getElementById("formModal");
    const openFormBtn = document.getElementById("openFormBtn");
    const closeFormBtn = document.getElementById("closeFormBtn");
    const achievementForm = document.getElementById("achievementForm");
    const formTitle = document.getElementById("formTitle");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const saveBtn = document.getElementById("saveBtn");

    const nameEl = document.getElementById("name");
    const upazilaEl = document.getElementById("upazila");
    const jobTypeEl = document.getElementById("jobType");
    const jobLocationEl = document.getElementById("jobLocation");
    const yearEl = document.getElementById("year");
    const organizationEl = document.getElementById("organization");
    const contactEl = document.getElementById("contact");
    const editIdEl = document.getElementById("editId");

    const setupModal = document.getElementById("setupModal");
    const openSetupBtn = document.getElementById("openSetupBtn");
    const openSetupBtn2 = document.getElementById("openSetupBtn2");
    const closeSetupBtn = document.getElementById("closeSetupBtn");
    const firebaseConfigInput = document.getElementById("firebaseConfigInput");
    const saveConfigBtn = document.getElementById("saveConfigBtn");
    const clearConfigBtn = document.getElementById("clearConfigBtn");
    const setupStatus = document.getElementById("setupStatus");
    const modeBanner = document.getElementById("modeBanner");
    const modeText = document.getElementById("modeText");

    // Utilities
    yearNow.textContent = new Date().getFullYear();
    function uidOrToken() {
      if (state.mode === "firebase" && state.firebase.uid) return state.firebase.uid;
      let token = localStorage.getItem(LS_KEYS.deviceToken);
      if (!token) { token = cryptoId(); localStorage.setItem(LS_KEYS.deviceToken, token); }
      return token;
    }
    function cryptoId(){
      const a=new Uint8Array(16); crypto.getRandomValues(a);
      return Array.from(a).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    function esc(s){return (s??"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
    function timeAgo(ts){ if(!ts) return "just now"; const d=Date.now()-ts, m=Math.floor(d/60000);
      if(m<1) return "just now"; if(m<60) return m+" min ago"; const h=Math.floor(m/60);
      if(h<24) return h+" hr"+(h>1?"s":"")+" ago"; const days=Math.floor(h/24);
      if(days<30) return days+" day"+(days>1?"s":"")+" ago"; const mo=Math.floor(days/30);
      if(mo<12) return mo+" mo ago"; const y=Math.floor(mo/12); return y+" yr"+(y>1?"s":"")+" ago"; }

    // Modal helpers
    function openModal(el){ el.classList.add("open"); document.body.style.overflow="hidden"; }
    function closeModal(el){ el.classList.remove("open"); document.body.style.overflow="auto"; }

    // Filters
    let searchTimer=null;
    searchInput.addEventListener("input",()=>{ clearTimeout(searchTimer); searchTimer=setTimeout(()=>{ state.filters.query=searchInput.value.trim().toLowerCase(); renderDirectory(); },150); });
    filterUpazila.addEventListener("change",()=>{ state.filters.upazila=filterUpazila.value; renderDirectory(); });
    filterJobType.addEventListener("change",()=>{ state.filters.jobType=filterJobType.value; renderDirectory(); });

    // Tabs
    tabDirectory.addEventListener("click",()=>{
      tabDirectory.className="px-4 md:px-6 py-2 rounded-full btn-secondary focus-ring";
      tabUpazilas.className="px-4 md:px-6 py-2 rounded-full glass focus-ring";
      directoryView.classList.remove("hidden"); upazilaView.classList.add("hidden");
    });
    tabUpazilas.addEventListener("click",()=>{
      tabUpazilas.className="px-4 md:px-6 py-2 rounded-full btn-secondary focus-ring";
      tabDirectory.className="px-4 md:px-6 py-2 rounded-full glass focus-ring";
      directoryView.classList.add("hidden"); upazilaView.classList.remove("hidden");
      renderUpazilaSections();
    });

    // Form Modal open/close
    openFormBtn.addEventListener("click",()=>{ startAdd(); openModal(formModal); });
    closeFormBtn.addEventListener("click",()=> closeModal(formModal));
    formModal.addEventListener("click",(e)=>{ if(e.target===formModal) closeModal(formModal); });

    // Setup Modal open/close
    function openSetup(){ firebaseConfigInput.value = localStorage.getItem(LS_KEYS.fbConfig) || ""; setupStatus.textContent=""; openModal(setupModal); }
    openSetupBtn.addEventListener("click", openSetup);
    openSetupBtn2.addEventListener("click", openSetup);
    closeSetupBtn.addEventListener("click",()=> closeModal(setupModal));
    setupModal.addEventListener("click",(e)=>{ if(e.target===setupModal) closeModal(setupModal); });

    // Save/Clear Firebase config
    saveConfigBtn.addEventListener("click", async ()=>{
      try{
        const txt = firebaseConfigInput.value.trim();
        if(!txt) { setupStatus.textContent = "Please paste your Firebase config JSON."; return; }
        const conf = JSON.parse(txt);
        localStorage.setItem(LS_KEYS.fbConfig, JSON.stringify(conf));
        setupStatus.textContent = "Saved. Connecting...";
        await connectFirebase();
        setupStatus.textContent = state.mode==="firebase" ? "Connected! Real-time sync is on." : "Could not connect. Check your config.";
      }catch(err){
        setupStatus.textContent = "Invalid JSON. Please paste the exact config object.";
      }
    });
    clearConfigBtn.addEventListener("click", ()=>{
      localStorage.removeItem(LS_KEYS.fbConfig);
      teardownFirebase();
      setupStatus.textContent = "Config cleared. Back to Local mode.";
      updateModeBanner();
    });

    // Local storage fallback
    function loadLocal(){
      try{ const raw=localStorage.getItem(LS_KEYS.achievements); state.achievements = raw? JSON.parse(raw): []; }
      catch{ state.achievements = []; }
      updateJobTypeFilterOptions();
      renderAll();
    }
    function saveLocal(){
      localStorage.setItem(LS_KEYS.achievements, JSON.stringify(state.achievements));
      updateJobTypeFilterOptions();
    }

    // ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç ‡¶õ‡¶ø‡¶≤, ‡¶§‡¶æ‡¶á ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ö‡ßç‡¶õ‡¶ø‡¶≤ ‡¶®‡¶æ
    function updateModeBanner(){
      if(state.mode==="firebase"){
        modeBanner.className = "w-full bg-emerald-600 text-white text-sm";
        modeText.textContent = "Firebase mode: real-time sync is ON. Everyone with the link shares the same data.";
        openSetupBtn.classList.add("hidden");
      } else {
        modeBanner.className = "w-full bg-amber-400/90 text-emerald-950 text-sm";
        modeText.textContent = "Local mode: data is saved in this browser only. Click ‚ÄúFirebase Setup‚Äù to enable real-time sync for everyone.";
        openSetupBtn.classList.remove("hidden");
      }
    }

    // Firebase connect/teardown
    async function connectFirebase(){
      // DIRECT CONFIGURATION (Hardcoded)
      const config = {
        apiKey: "AIzaSyDw3OzTDXp5g8ymWm5jbl2Z1FhGMeREOuw",
        authDomain: "kurigramians-stars.firebaseapp.com",
        projectId: "kurigramians-stars",
        storageBucket: "kurigramians-stars.firebasestorage.app",
        messagingSenderId: "844222654198",
        appId: "1:844222654198:web:cb02b8b6f44c8991adaed7"
      };

      try{
        if (state.firebase.app) { 
           // already initialized
        } else {
          state.firebase.app = firebase.initializeApp(config);
          state.firebase.auth = firebase.auth();
          state.firebase.db = firebase.firestore();
        }

        if(!state.firebase.auth.currentUser){
          await state.firebase.auth.signInAnonymously();
        }
        state.firebase.uid = state.firebase.auth.currentUser ? state.firebase.auth.currentUser.uid : null;

        if(state.firebase.unsub){ state.firebase.unsub(); state.firebase.unsub=null; }
        
        const col = state.firebase.db.collection("achievements");
        state.firebase.unsub = col.orderBy("createdAt","desc").onSnapshot((snap)=>{
          const arr=[];
          snap.forEach(doc=>{
            const d=doc.data()||{};
            arr.push({
              id: doc.id,
              name: d.name||"",
              upazila: d.upazila||"",
              jobType: d.jobType||"",
              jobLocation: d.jobLocation||"",
              year: Number(d.year)||"",
              organization: d.organization||"",
              contact: d.contact||"",
              createdBy: d.createdBy||"",
              createdAt: Number(d.createdAt)||Date.now(),
              updatedAt: Number(d.updatedAt)||Date.now()
            });
          });
          state.achievements = arr;
          updateJobTypeFilterOptions();
          renderAll();
        },(err)=>{
          console.warn("Snapshot error", err);
        });
        
        state.mode = "firebase";
        updateModeBanner();

      }catch(e){
        console.warn("Firebase init failed", e);
        state.mode = "local";
        updateModeBanner();
      }
    }
  

    // Renderers
    function applyFilters(list){
      const q=state.filters.query, upz=state.filters.upazila, jt=state.filters.jobType;
      return list.filter(item=>{
        const matchQ = !q || (item.name.toLowerCase().includes(q) || item.jobType.toLowerCase().includes(q) || item.organization.toLowerCase().includes(q) || item.jobLocation.toLowerCase().includes(q));
        const matchUpz = !upz || item.upazila===upz;
        const matchJt = !jt || item.jobType===jt;
        return matchQ && matchUpz && matchJt;
      });
    }
    function updateJobTypeFilterOptions(){
      const selected = filterJobType.value || "";
      const unique = Array.from(new Set((state.achievements||[]).map(a=>a.jobType).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      filterJobType.innerHTML = '<option value="">All Job Types</option>'+ unique.map(v=>`<option>${esc(v)}</option>`).join("");
      filterJobType.value = selected;
    }
    function renderDirectory(){
      const list = applyFilters(state.achievements||[]);
      directoryList.innerHTML = "";
      if(list.length===0){ emptyState.classList.remove("hidden"); } else { emptyState.classList.add("hidden"); }
      list.forEach(item=> directoryList.appendChild(makeCard(item)));
    }
    function renderUpazilaSections(){
      upazilaSections.innerHTML = "";
      UPZs.forEach(upz=>{
        const items = (state.achievements||[]).filter(a=>a.upazila===upz);
        const wrapper = document.createElement("div");
        wrapper.className = "accordion glass rounded-2xl shadow-soft";
        wrapper.innerHTML = `
          <button class="w-full text-left px-5 md:px-6 py-4 md:py-5 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <span class="inline-flex h-9 w-9 items-center justify-center rounded-full tag text-black/90 font-bold">üèÖ</span>
              <div>
                <h4 class="text-lg md:text-xl font-bold">${esc(upz)}</h4>
                <p class="text-emerald-50/80 text-sm">${items.length} achievement${items.length!==1?"s":""}</p>
              </div>
            </div>
            <span class="text-2xl caret">+</span>
          </button>
          <div class="accordion-content px-5 md:px-6 pb-5 md:pb-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 upz-grid"></div>
          </div>
        `;
        const grid = wrapper.querySelector(".upz-grid");
        items.forEach(item=> grid.appendChild(makeCard(item)));
        const btn = wrapper.querySelector("button");
        btn.addEventListener("click", ()=>{
          wrapper.classList.toggle("open");
          wrapper.querySelector(".caret").textContent = wrapper.classList.contains("open") ? "‚àí" : "+";
        });
        upazilaSections.appendChild(wrapper);
      });
    }
    function makeCard(item){
      const ownerId = state.mode==="firebase" ? state.firebase.uid : uidOrToken();
      const owner = item.createdBy === ownerId;
      const card = document.createElement("div");
      card.className = "card-hover rounded-2xl p-5 bg-white/10";
      const contactLine = item.contact ? `
        <div class="flex items-center gap-2"><span>üìû</span><span class="text-emerald-50/90 break-words">${esc(item.contact)}</span></div>` : "";
      card.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <h5 class="text-xl font-bold">${esc(item.name)}</h5>
            <p class="text-emerald-50/80">${esc(item.jobType)} ‚Ä¢ ${esc(item.organization)}</p>
          </div>
          <span class="px-3 py-1 rounded-full text-xs bg-white/15">${esc(item.upazila)}</span>
        </div>
        <div class="mt-4 space-y-2 text-sm">
          <div class="flex items-center gap-2"><span>üìç</span><span class="text-emerald-50/90">${esc(item.jobLocation)}</span></div>
          <div class="flex items-center gap-2"><span>üìÖ</span><span class="text-emerald-50/90">Year: ${esc(String(item.year))}</span></div>
          ${contactLine}
        </div>
        <div class="mt-4 flex items-center justify-between">
          <span class="text-xs text-emerald-50/70">Added ${timeAgo(item.createdAt)}</span>
          <div class="flex items-center gap-2">
            ${owner ? `<button data-action="edit" class="px-3 py-2 rounded-lg glass text-sm">Edit</button>
                       <button data-action="delete" class="px-3 py-2 rounded-lg btn-danger text-sm">Delete</button>` : ``}
          </div>
        </div>
      `;
      const editBtn = card.querySelector('[data-action="edit"]');
      const delBtn = card.querySelector('[data-action="delete"]');
      if(editBtn){ editBtn.addEventListener("click", ()=> startEdit(item)); }
      if(delBtn){ delBtn.addEventListener("click", async ()=>{
        if(confirm("Delete this achievement?")){ await deleteById(item.id); }
      }); }
      return card;
    }
    function renderAll(){ renderDirectory(); renderUpazilaSections(); }

    // Add/Edit flow
    function startAdd(){
      achievementForm.reset();
      state.editingId = null;
      editIdEl.value = "";
      formTitle.textContent = "Add Achievement";
      saveBtn.textContent = "Save Achievement";
      cancelEditBtn.classList.add("hidden");
    }
    function startEdit(item){
      state.editingId = item.id;
      editIdEl.value = item.id;
      formTitle.textContent = "Edit Achievement";
      saveBtn.textContent = "Update Achievement";
      cancelEditBtn.classList.remove("hidden");
      nameEl.value = item.name; upazilaEl.value=item.upazila; jobTypeEl.value=item.jobType;
      jobLocationEl.value=item.jobLocation; yearEl.value=item.year; organizationEl.value=item.organization; contactEl.value=item.contact||"";
      openModal(formModal);
    }
    cancelEditBtn.addEventListener("click", ()=>{ startAdd(); closeModal(formModal); });

    achievementForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const base = {
        name: nameEl.value.trim(),
        upazila: upazilaEl.value,
        jobType: jobTypeEl.value.trim(),
        jobLocation: jobLocationEl.value.trim(),
        year: parseInt(yearEl.value,10),
        organization: organizationEl.value.trim(),
        contact: contactEl.value.trim(),
        updatedAt: Date.now()
      };
      if(!base.name||!base.upazila||!base.jobType||!base.jobLocation||!base.year||!base.organization){
        alert("Please fill in all required fields."); return;
      }
      if(state.editingId){
        const item = (state.achievements||[]).find(a=>a.id===state.editingId);
        if(!item){ alert("Item not found."); return; }
        const ownerId = state.mode==="firebase" ? state.firebase.uid : uidOrToken();
        if(item.createdBy !== ownerId){ alert("You can only edit your own entry."); return; }
        await addOrUpdate({ ...item, ...base, id: state.editingId });
      } else {
        await addOrUpdate({ ...base });
      }
      startAdd(); closeModal(formModal);
    });

    // Init
    (async function init(){
      updateModeBanner();
      // Try connect Firebase if config present
      await connectFirebase();
      if(state.mode==="local"){ loadLocal(); }
      // Default to Directory tab
      tabDirectory.click();
      // Seed demo items for first-run local only
      if(state.mode==="local" && (!state.achievements||state.achievements.length===0)){
        state.achievements = [
          {id: cryptoId(), name:"Rahim Uddin", upazila:"Kurigram Sadar", jobType:"BCS Cadre", jobLocation:"Dhaka", year:2023, organization:"Ministry of Finance", contact:"", createdBy: uidOrToken(), createdAt: Date.now()-10000000, updatedAt: Date.now()-10000000},
          {id: cryptoId(), name:"Nasrin Akter", upazila:"Ulipur", jobType:"Teacher", jobLocation:"Kurigram", year:2022, organization:"Govt. High School", contact:"", createdBy: uidOrToken(), createdAt: Date.now()-8000000, updatedAt: Date.now()-8000000},
          {id: cryptoId(), name:"Jahid Hasan", upazila:"Chilmari", jobType:"Govt. Officer", jobLocation:"Rangpur", year:2021, organization:"LGED", contact:"", createdBy: uidOrToken(), createdAt: Date.now()-6000000, updatedAt: Date.now()-6000000}
        ];
        saveLocal(); renderAll(); updateJobTypeFilterOptions();
      }
    })();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'982bc7bf21aaded3',t:'MTc1ODQ4MDk2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
